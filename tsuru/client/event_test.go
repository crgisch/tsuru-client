// Copyright 2017 tsuru-client authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file.

package client

import (
	"bytes"
	"fmt"
	"net/http"
	"os"

	"github.com/tsuru/tsuru/cmd"
	"github.com/tsuru/tsuru/cmd/cmdtest"
	"gopkg.in/check.v1"
)

var okEvt = `
{
  "UniqueID": "578e3908413daf5fd9891aac",
  "StartTime": "2016-07-19T11:28:24.686-03:00",
  "EndTime": "2016-07-19T11:29:22.01-03:00",
  "Target": {
    "Type": "app",
    "Value": "myapp"
  },
  "ExtraTargets": [{"Target": {"Type": "app", "Value": "myapp2"}}],
  "CustomData": {
    "Start": {"app": {"env": {"TSURU_APP_TOKEN": {"name": "TSURU_APP_TOKEN", "value": "900d072c007a7f8029ff7b2ce79351b24ea64b3f", "public": false, "instancename": ""}, "TSURU_APPNAME": {"name": "TSURU_APPNAME", "value": "otherapp", "public": false, "instancename": ""}, "TSURU_APPDIR": {"name": "TSURU_APPDIR", "value": "/home/application/current", "public": false, "instancename": ""}}, "framework": "python", "name": "otherapp", "ip": "otherapp.fakerouter.com", "cname": [], "teams": ["tsuruteam"], "teamowner": "tsuruteam", "owner": "majortom@groundcontrol.com", "deploys": 0, "updateplatform": false, "lock": {"locked": true, "reason": "POST /apps/otherapp/repository/clone", "owner": "majortom@groundcontrol.com", "acquiredate": "2016-07-19T20:03:18.390000"}, "plan": {"_id": "autogenerated", "memory": 0, "swap": 0, "cpushare": 100, "default": false, "router": ""}, "pool": "pool1", "description": "", "routeropts": {}, "quota": {"limit": -1, "inuse": 0}}, "commit": "", "archiveurl": "http://something.tar.gz", "filesize": 0, "user": "majortom@groundcontrol.com", "image": "", "origin": "", "rollback": false, "build": false, "kind": "archive-url", "message": ""},
    "End": {"image": "app-image"},
    "Other": null
  },

  "EndCustomData": {
    "Kind": 3,
    "Data": "GgAAAAJpbWFnZQAKAAAAYXBwLWltYWdlAAA="
  },
  "OtherCustomData": {
    "Kind": 0,
    "Data": null
  },
  "Kind": {
    "Type": "permission",
    "Name": "app.deploy"
  },
  "Owner": {
    "Type": "user",
    "Name": "someone@removed.com"
  },
  "LockUpdateTime": "2016-07-19T11:28:24.686-03:00",
  "Error": "",
  "Log": "Obtaining file:///home/application/current (from -r /home/application/current/requirements.txt (line 1))\n  appxxxx 0.1.0 does not provide the extra 'tests'\nRequirement already satisfied (use --upgrade to upgrade): Flask in /home/application/.app_env/lib/python2.7/site-packages (from appxxxx==0.1.0-\u003e-r /home/application/current/requirements.txt (line 1))\nRequirement already satisfied (use --upgrade to upgrade): redis in /home/application/.app_env/lib/python2.7/site-packages (from appxxxx==0.1.0-\u003e-r /home/application/current/requirements.txt (line 1))\nRequirement already satisfied (use --upgrade to upgrade): click\u003e=2.0 in /home/application/.app_env/lib/python2.7/site-packages (from Flask-\u003eappxxxx==0.1.0-\u003e-r /home/application/current/requirements.txt (line 1))\nRequirement already satisfied (use --upgrade to upgrade): itsdangerous\u003e=0.21 in /home/application/.app_env/lib/python2.7/site-packages (from Flask-\u003eappxxxx==0.1.0-\u003e-r /home/application/current/requirements.txt (line 1))\nRequirement already satisfied (use --upgrade to upgrade): Werkzeug\u003e=0.7 in /home/application/.app_env/lib/python2.7/site-packages (from Flask-\u003eappxxxx==0.1.0-\u003e-r /home/application/current/requirements.txt (line 1))\nRequirement already satisfied (use --upgrade to upgrade): Jinja2\u003e=2.4 in /home/application/.app_env/lib/python2.7/site-packages (from Flask-\u003eappxxxx==0.1.0-\u003e-r /home/application/current/requirements.txt (line 1))\nRequirement already satisfied (use --upgrade to upgrade): MarkupSafe in /home/application/.app_env/lib/python2.7/site-packages (from Jinja2\u003e=2.4-\u003eFlask-\u003eappxxxx==0.1.0-\u003e-r /home/application/current/requirements.txt (line 1))\nInstalling collected packages: appxxxx\n  Running setup.py develop for appxxxx\nSuccessfully installed appxxxx-0.1.0\n\n---- Building application image ----\n ---\u003e Sending image to repository (0.06MB)\n ---\u003e Cleaning up\n\n---- Starting 1 new unit [web: 1] ----\n ---\u003e Started unit 447fc77ff3 [web]\n\n---- Binding and checking 1 new unit ----\n ---\u003e healthcheck fail(447fc77ff3): Get http://10.0.0.1:32774/: dial tcp 10.0.0.1:32774: getsockopt: connection refused. Trying again in 3s\n ---\u003e healthcheck successful(447fc77ff3)\n ---\u003e Bound and checked unit 447fc77ff3 [web]\n\n---- Adding routes to new units ----\n ---\u003e Added route to unit 447fc77ff3 [web]\n\n---- Removing routes from old units ----\n ---\u003e Removed route from unit d535216e4b [web]\n\n---- Removing 1 old unit ----\n ---\u003e Removed old unit d535216e4b [web]\n\n---- Unbinding 1 old unit ----\n ---\u003e Removed bind for old unit d535216e4b [web]\n",
  "RemoveDate": "0001-01-01T00:00:00Z",
  "CancelInfo": {
    "Owner": "",
    "StartTime": "0001-01-01T00:00:00Z",
    "AckTime": "0001-01-01T00:00:00Z",
    "Reason": "",
    "Asked": false,
    "Canceled": false
  },
  "Cancelable": true,
  "Running": false
}
`
var canceledEvt = `
{
  "ID": {
    "Target": {
      "Type": "",
      "Value": ""
    },
    "ObjId": "888e3908413daf5fd9891aac"
  },
  "UniqueID": "888e3908413daf5fd9891aac",
  "StartTime": "2016-07-19T11:28:24.686-03:00",
  "EndTime": "2016-07-19T11:29:22.01-03:00",
  "Target": {
    "Type": "app",
    "Value": "myapp"
  },
  "Kind": {
    "Type": "permission",
    "Name": "app.deploy"
  },
  "Owner": {
    "Type": "user",
    "Name": "someone@removed.com"
  },
  "Error": "canceled by user action",
  "Log": "",
  "RemoveDate": "0001-01-01T00:00:00Z",
  "CancelInfo": {
    "Owner": "evil@corp",
    "StartTime": "2016-07-19T11:28:25.686-03:00",
    "AckTime": "2016-07-19T11:28:26.686-03:00",
    "Reason": "because yes",
    "Asked": true,
    "Canceled": true
  },
  "Cancelable": true,
  "Running": false
}
`
var runningEvt = `
{
  "ID": {
    "Target": {
      "Type": "app",
      "Value": "myapp"
    },
    "ObjId": ""
  },
  "UniqueID": "998e3908413daf5fd9891aac",
  "StartTime": "2016-07-19T11:27:24.686-03:00",
  "Target": {
    "Type": "app",
    "Value": "myapp"
  },
  "Kind": {
    "Type": "permission",
    "Name": "app.deploy"
  },
  "Owner": {
    "Type": "user",
    "Name": "someone@removed.com"
  },
  "Error": "",
  "Log": "",
  "RemoveDate": "0001-01-01T00:00:00Z",
  "CancelInfo": {
    "Owner": "",
    "StartTime": "0001-01-01T00:00:00Z",
    "AckTime": "0001-01-01T00:00:00Z",
    "Reason": "",
    "Asked": false,
    "Canceled": false
  },
  "Cancelable": true,
  "Running": true
}
`

var errEvt = `
{
  "UniqueID": "5787bcc8413daf2aeb040730",
  "StartTime": "2016-07-14T13:24:40.66-03:00",
  "EndTime": "2016-07-14T13:25:00.349-03:00",
  "Target": {
    "Type": "container",
    "Value": "94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f"
  },
  "Kind": {
    "Type": "internal",
    "Name": "healer"
  },
  "Owner": {
    "Type": "internal",
    "Name": ""
  },
  "LockUpdateTime": "2016-07-14T13:24:40.66-03:00",
  "Error": "Error healing container \"94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f\": Error trying to heal containers 94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f: couldn't move container: Error moving some containers. - Moving unit 94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f for \"myapp\" from 10.0.0.4...\nError moving container: Error moving unit 94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f Caused by: Post http://10.0.0.5:8000/services/myapp/destinations: dial tcp 10.0.0.5:8000: getsockopt: no route to host\n",
  "Log": "",
  "RemoveDate": "0001-01-01T00:00:00Z",
  "CancelInfo": {
    "Owner": "",
    "StartTime": "0001-01-01T00:00:00Z",
    "AckTime": "0001-01-01T00:00:00Z",
    "Reason": "",
    "Asked": false,
    "Canceled": false
  },
  "Cancelable": false,
  "Running": false
}
`
var evtsData = fmt.Sprintf("[%s, %s, %s, %s]", okEvt, canceledEvt, runningEvt, errEvt)

func (s *S) TestEventListInfo(c *check.C) {
	c.Assert((&EventList{}).Info(), check.NotNil)
}

func (s *S) TestEventList(c *check.C) {
	os.Setenv("TSURU_DISABLE_COLORS", "1")
	defer os.Unsetenv("TSURU_DISABLE_COLORS")
	var stdout, stderr bytes.Buffer
	context := cmd.Context{
		Args:   []string{},
		Stdout: &stdout,
		Stderr: &stderr,
	}
	trans := &cmdtest.ConditionalTransport{
		Transport: cmdtest.Transport{Message: evtsData, Status: http.StatusOK},
		CondFunc: func(req *http.Request) bool {
			for _, value := range req.URL.Query() {
				c.Assert(value, check.DeepEquals, []string{""})
			}
			return req.URL.Path == "/1.1/events"
		},
	}
	s.setupFakeTransport(trans)
	command := EventList{}
	err := command.Run(&context)
	c.Assert(err, check.IsNil)
	expected := `+--------------------------+-----------------------------+---------+-----------+------------+-------------------------+
| ID                       | Start (duration)            | Success | Owner     | Kind       | Target                  |
+--------------------------+-----------------------------+---------+-----------+------------+-------------------------+
| 578e3908413daf5fd9891aac | 19 Jul 16 09:28 CDT (00:57) | true    | someone@… | app.deploy | app: myapp              |
|                          |                             |         |           |            | app: myapp2             |
+--------------------------+-----------------------------+---------+-----------+------------+-------------------------+
| 888e3908413daf5fd9891aac | 19 Jul 16 09:28 CDT (00:57) | false ✗ | someone@… | app.deploy | app: myapp              |
+--------------------------+-----------------------------+---------+-----------+------------+-------------------------+
| 998e3908413daf5fd9891aac | 19 Jul 16 09:27 CDT (…)     | …       | someone@… | app.deploy | app: myapp              |
+--------------------------+-----------------------------+---------+-----------+------------+-------------------------+
| 5787bcc8413daf2aeb040730 | 14 Jul 16 11:24 CDT (00:19) | false   |           | healer     | container: 94d3140395a8 |
+--------------------------+-----------------------------+---------+-----------+------------+-------------------------+
`
	c.Assert(stdout.String(), check.Equals, expected)
}

func (s *S) TestEventListWithFilters(c *check.C) {
	var stdout, stderr bytes.Buffer
	context := cmd.Context{
		Args:   []string{},
		Stdout: &stdout,
		Stderr: &stderr,
	}
	trans := &cmdtest.ConditionalTransport{
		Transport: cmdtest.Transport{Message: evtsData, Status: http.StatusOK},
		CondFunc: func(req *http.Request) bool {
			c.Assert(req.URL.Path, check.Equals, "/1.1/events")
			c.Assert(req.Method, check.Equals, http.MethodGet)
			c.Assert(req.URL.Query()["kindname"], check.DeepEquals, []string{"app.update", "app.deploy"})
			c.Assert(req.URL.Query().Get("ownername"), check.Equals, "event-owner")
			c.Assert(req.URL.Query().Get("target.type"), check.Equals, "app")
			c.Assert(req.URL.Query().Get("target.value"), check.Equals, "appname")
			c.Assert(req.URL.Query().Get("running"), check.Equals, "true")
			return true
		},
	}
	s.setupFakeTransport(trans)
	command := EventList{}
	err := command.Flags().Parse(true, []string{"-k", "app.update", "-k", "app.deploy", "-o", "event-owner", "-t", "app", "-v", "appname", "-r"})
	c.Assert(err, check.IsNil)
	err = command.Run(&context)
	c.Assert(err, check.IsNil)
}

func (s *S) TestEventInfoInfo(c *check.C) {
	c.Assert((&EventInfo{}).Info(), check.NotNil)
}

func (s *S) TestEventInfo(c *check.C) {
	os.Setenv("TSURU_DISABLE_COLORS", "1")
	defer os.Unsetenv("TSURU_DISABLE_COLORS")
	var stdout, stderr bytes.Buffer
	context := cmd.Context{
		Args:   []string{"578e3908413daf5fd9891aac"},
		Stdout: &stdout,
		Stderr: &stderr,
	}
	trans := &cmdtest.ConditionalTransport{
		Transport: cmdtest.Transport{Message: okEvt, Status: http.StatusOK},
		CondFunc: func(req *http.Request) bool {
			return req.URL.Path == "/1.1/events/578e3908413daf5fd9891aac"
		},
	}
	s.setupFakeTransport(trans)
	command := EventInfo{}
	err := command.Run(&context)
	c.Assert(err, check.IsNil)
	expected := `ID:         578e3908413daf5fd9891aac
Start:      19 Jul 16 09:28 CDT
End:        19 Jul 16 09:29 CDT \(00:57\)
Targets:    app\(myapp\)
            app\(myapp2\)
Kind:       permission\(app\.deploy\)
Owner:      user\(someone@removed\.com\)
Success:    true
Cancelable: true
Canceled:   false
Start Custom Data:
    app:
      cname: \[\]
      deploys: 0
      description: ""
      env:
        TSURU_APP_TOKEN:
          instancename: ""
          name: TSURU_APP_TOKEN
          public: false
          value: 900d072c007a7f8029ff7b2ce79351b24ea64b3f
        TSURU_APPDIR:
          instancename: ""
          name: TSURU_APPDIR
          public: false
          value: /home/application/current
        TSURU_APPNAME:
          instancename: ""
          name: TSURU_APPNAME
          public: false
          value: otherapp
      framework: python
      ip: otherapp\.fakerouter\.com
      lock:
        acquiredate: .*?
        locked: true
        owner: majortom@groundcontrol\.com
        reason: POST /apps/otherapp/repository/clone
      name: otherapp
      owner: majortom@groundcontrol\.com
      plan:
        _id: autogenerated
        cpushare: 100
        default: false
        memory: 0
        router: ""
        swap: 0
      pool: pool1
      quota:
        inuse: 0
        limit: -1
      routeropts: {}
      teamowner: tsuruteam
      teams:
      - tsuruteam
      updateplatform: false
    archiveurl: http://something\.tar\.gz
    build: false
    commit: ""
    filesize: 0
    image: ""
    kind: archive-url
    message: ""
    origin: ""
    rollback: false
    user: majortom@groundcontrol\.com

End Custom Data:
    image: app-image

Log:
    Obtaining file:///home/application/current \(from -r /home/application/current/requirements\.txt \(line 1\)\)
      appxxxx 0\.1\.0 does not provide the extra 'tests'
    Requirement already satisfied \(use --upgrade to upgrade\): Flask in /home/application/\.app_env/lib/python2\.7/site-packages \(from appxxxx==0\.1\.0->-r /home/application/current/requirements\.txt \(line 1\)\)
    Requirement already satisfied \(use --upgrade to upgrade\): redis in /home/application/\.app_env/lib/python2\.7/site-packages \(from appxxxx==0\.1\.0->-r /home/application/current/requirements\.txt \(line 1\)\)
    Requirement already satisfied \(use --upgrade to upgrade\): click>=2\.0 in /home/application/\.app_env/lib/python2\.7/site-packages \(from Flask->appxxxx==0\.1\.0->-r /home/application/current/requirements\.txt \(line 1\)\)
    Requirement already satisfied \(use --upgrade to upgrade\): itsdangerous>=0\.21 in /home/application/\.app_env/lib/python2\.7/site-packages \(from Flask->appxxxx==0\.1\.0->-r /home/application/current/requirements\.txt \(line 1\)\)
    Requirement already satisfied \(use --upgrade to upgrade\): Werkzeug>=0\.7 in /home/application/\.app_env/lib/python2\.7/site-packages \(from Flask->appxxxx==0\.1\.0->-r /home/application/current/requirements\.txt \(line 1\)\)
    Requirement already satisfied \(use --upgrade to upgrade\): Jinja2>=2\.4 in /home/application/\.app_env/lib/python2\.7/site-packages \(from Flask->appxxxx==0\.1\.0->-r /home/application/current/requirements\.txt \(line 1\)\)
    Requirement already satisfied \(use --upgrade to upgrade\): MarkupSafe in /home/application/\.app_env/lib/python2\.7/site-packages \(from Jinja2>=2\.4->Flask->appxxxx==0\.1\.0->-r /home/application/current/requirements\.txt \(line 1\)\)
    Installing collected packages: appxxxx
      Running setup\.py develop for appxxxx
    Successfully installed appxxxx-0\.1\.0

    ---- Building application image ----
     ---> Sending image to repository \(0\.06MB\)
     ---> Cleaning up

    ---- Starting 1 new unit \[web: 1\] ----
     ---> Started unit 447fc77ff3 \[web\]

    ---- Binding and checking 1 new unit ----
     ---> healthcheck fail\(447fc77ff3\): Get http://10\.0\.0\.1:32774/: dial tcp 10\.0\.0\.1:32774: getsockopt: connection refused\. Trying again in 3s
     ---> healthcheck successful\(447fc77ff3\)
     ---> Bound and checked unit 447fc77ff3 \[web\]

    ---- Adding routes to new units ----
     ---> Added route to unit 447fc77ff3 \[web\]

    ---- Removing routes from old units ----
     ---> Removed route from unit d535216e4b \[web\]

    ---- Removing 1 old unit ----
     ---> Removed old unit d535216e4b \[web\]

    ---- Unbinding 1 old unit ----
     ---> Removed bind for old unit d535216e4b \[web\]

`
	c.Assert(stdout.String(), check.Matches, expected)
}

func (s *S) TestEventInfoWithError(c *check.C) {
	os.Setenv("TSURU_DISABLE_COLORS", "1")
	defer os.Unsetenv("TSURU_DISABLE_COLORS")
	var stdout, stderr bytes.Buffer
	context := cmd.Context{
		Args:   []string{"5787bcc8413daf2aeb040730"},
		Stdout: &stdout,
		Stderr: &stderr,
	}
	trans := &cmdtest.ConditionalTransport{
		Transport: cmdtest.Transport{Message: errEvt, Status: http.StatusOK},
		CondFunc: func(req *http.Request) bool {
			return req.URL.Path == "/1.1/events/5787bcc8413daf2aeb040730"
		},
	}
	s.setupFakeTransport(trans)
	command := EventInfo{}
	err := command.Run(&context)
	c.Assert(err, check.IsNil)
	expected := `ID:         5787bcc8413daf2aeb040730
Start:      14 Jul 16 11:24 CDT
End:        14 Jul 16 11:25 CDT \(00:19\)
Targets:    container\(94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f\)
Kind:       internal\(healer\)
Owner:      internal\(\)
Success:    false
Error:
Error healing container "94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f": Error trying to heal containers 94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f: couldn't move container: Error moving some containers\. - Moving unit 94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f for "myapp" from 10\.0\.0\.4\.\.\.
Error moving container: Error moving unit 94d3140395a85e4a60b06de26f6a51270d7b762c65cc9478e2c544ae4d7fb82f Caused by: Post http://10\.0\.0\.5:8000/services/myapp/destinations: dial tcp 10\.0\.0\.5:8000: getsockopt: no route to host

Cancelable: false
Canceled:   false
`
	c.Assert(stdout.String(), check.Matches, expected)
}

func (s *S) TestEventInfoRunning(c *check.C) {
	os.Setenv("TSURU_DISABLE_COLORS", "1")
	defer os.Unsetenv("TSURU_DISABLE_COLORS")
	var stdout, stderr bytes.Buffer
	context := cmd.Context{
		Args:   []string{"998e3908413daf5fd9891aac"},
		Stdout: &stdout,
		Stderr: &stderr,
	}
	trans := &cmdtest.ConditionalTransport{
		Transport: cmdtest.Transport{Message: runningEvt, Status: http.StatusOK},
		CondFunc: func(req *http.Request) bool {
			return req.URL.Path == "/1.1/events/998e3908413daf5fd9891aac"
		},
	}
	s.setupFakeTransport(trans)
	command := EventInfo{}
	err := command.Run(&context)
	c.Assert(err, check.IsNil)
	expected := `ID:         998e3908413daf5fd9891aac
Start:      19 Jul 16 09:27 CDT
End:        running \(.+\)
Targets:    app\(myapp\)
Kind:       permission\(app\.deploy\)
Owner:      user\(someone@removed\.com\)
Success:    …
Cancelable: true
Canceled:   false
`
	c.Assert(stdout.String(), check.Matches, expected)
}

func (s *S) TestEventInfoCanceled(c *check.C) {
	os.Setenv("TSURU_DISABLE_COLORS", "1")
	defer os.Unsetenv("TSURU_DISABLE_COLORS")
	var stdout, stderr bytes.Buffer
	context := cmd.Context{
		Args:   []string{"888e3908413daf5fd9891aac"},
		Stdout: &stdout,
		Stderr: &stderr,
	}
	trans := &cmdtest.ConditionalTransport{
		Transport: cmdtest.Transport{Message: canceledEvt, Status: http.StatusOK},
		CondFunc: func(req *http.Request) bool {
			return req.URL.Path == "/1.1/events/888e3908413daf5fd9891aac"
		},
	}
	s.setupFakeTransport(trans)
	command := EventInfo{}
	err := command.Run(&context)
	c.Assert(err, check.IsNil)
	expected := `ID:         888e3908413daf5fd9891aac
Start:      19 Jul 16 09:28 CDT
End:        19 Jul 16 09:29 CDT \(00:57\)
Targets:    app\(myapp\)
Kind:       permission\(app\.deploy\)
Owner:      user\(someone@removed\.com\)
Success:    false
Error:
canceled by user action

Cancelable: true
Canceled:   true
  Reason:   because yes
  By:       evil@corp
  At:       19 Jul 16 11:28 -0300
`
	c.Assert(stdout.String(), check.Matches, expected)
}

func (s *S) TestEventCancelInfo(c *check.C) {
	c.Assert((&EventCancel{}).Info(), check.NotNil)
}

func (s *S) TestEventCancel(c *check.C) {
	var stdout, stderr bytes.Buffer
	context := cmd.Context{
		Args:   []string{"998e3908413daf5fd9891aac", "my", "reason"},
		Stdout: &stdout,
		Stderr: &stderr,
	}
	trans := &cmdtest.ConditionalTransport{
		Transport: cmdtest.Transport{Message: runningEvt, Status: http.StatusOK},
		CondFunc: func(req *http.Request) bool {
			c.Assert(req.FormValue("reason"), check.Equals, "my reason")
			return req.URL.Path == "/1.1/events/998e3908413daf5fd9891aac/cancel" && req.Method == "POST"
		},
	}
	s.setupFakeTransport(trans)
	command := EventCancel{}
	command.Flags().Parse(true, []string{"-y"})
	err := command.Run(&context)
	c.Assert(err, check.IsNil)
	c.Assert(stdout.String(), check.Matches, "Cancellation successfully requested.\n")
}
